<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Lottery - Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #222222;
            --tg-theme-button-color: #40a7e3;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f1f1f1;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2481cc;
            --tg-theme-header-bg-color: #ffffff;
            --tg-theme-accent-text-color: #2481cc;
            --tg-theme-section-bg-color: #ffffff;
            --tg-theme-section-header-text-color: #2481cc;
            --tg-theme-subtitle-text-color: #999999;
            --tg-theme-destructive-text-color: #e53935;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 16px 0;
            background-color: var(--tg-theme-header-bg-color);
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
        }

        .balance {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 12px 16px;
            border-radius: 10px;
            margin: 16px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .balance-amount {
            font-size: 20px;
            font-weight: 700;
        }

        .section {
            margin: 20px 0;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--tg-theme-section-header-text-color);
        }

        .symbols-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .symbol-item {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }

        .symbol-item:hover {
            transform: translateY(-2px);
        }

        .symbol-item.selected {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .symbol-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .symbol-name {
            font-weight: 600;
        }

        .bet-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 16px 0;
        }

        .bet-option {
            background-color: var(--tg-theme-secondary-bg-color);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .bet-option.selected {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .action-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 12px;
            padding: 16px;
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            cursor: pointer;
            margin-top: 16px;
            transition: opacity 0.2s;
        }

        .action-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .history {
            margin-top: 24px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
        }

        .history-symbol {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-icon {
            font-size: 20px;
        }

        .history-result {
            font-weight: 600;
        }

        .history-win {
            color: #31b545;
        }

        .history-loss {
            color: var(--tg-theme-destructive-text-color);
        }

        .premium-section {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border-radius: 12px;
            padding: 16px;
            margin: 24px 0;
            text-align: center;
        }

        .premium-title {
            font-weight: 700;
            font-size: 18px;
            margin-bottom: 8px;
        }

        .telegram-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            display: inline-block;
        }

        .payment-section {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            padding: 16px;
            margin: 20px 0;
        }

        .payment-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .payment-option:last-child {
            border-bottom: none;
        }

        .payment-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .loader {
            border: 4px solid var(--tg-theme-secondary-bg-color);
            border-top: 4px solid var(--tg-theme-button-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Star –õ–æ—Ç–µ—Ä–µ—è</h1>
        </div>

        <div class="balance">
            <span>–í–∞—à –±–∞–ª–∞–Ω—Å:</span>
            <span class="balance-amount" id="balance">0 ‚≠ê</span>
        </div>

        <div class="section">
            <div class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∏–º–≤–æ–ª</div>
            <div class="symbols-grid">
                <div class="symbol-item" data-symbol="ring">
                    <div class="symbol-icon">üíç</div>
                    <div class="symbol-name">–ö–æ–ª—å—Ü–æ</div>
                </div>
                <div class="symbol-item" data-symbol="cup">
                    <div class="symbol-icon">üèÜ</div>
                    <div class="symbol-name">–ö—É–±–æ–∫</div>
                </div>
                <div class="symbol-item" data-symbol="heart">
                    <div class="symbol-icon">‚ù§Ô∏è</div>
                    <div class="symbol-name">–°–µ—Ä–¥—Ü–µ</div>
                </div>
                <div class="symbol-item" data-symbol="bear">
                    <div class="symbol-icon">üêª</div>
                    <div class="symbol-name">–ú–µ–¥–≤–µ–¥—å</div>
                </div>
                <div class="symbol-item" data-symbol="diamond">
                    <div class="symbol-icon">üíé</div>
                    <div class="symbol-name">–ê–ª–º–∞–∑</div>
                </div>
                <div class="symbol-item" data-symbol="rose">
                    <div class="symbol-icon">üåπ</div>
                    <div class="symbol-name">–†–æ–∑–∞</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞–≤–∫—É</div>
            <div class="bet-options">
                <button class="bet-option" data-bet="15">15 ‚≠ê</button>
                <button class="bet-option" data-bet="25">25 ‚≠ê</button>
                <button class="bet-option" data-bet="50">50 ‚≠ê</button>
                <button class="bet-option" data-bet="100">100 ‚≠ê</button>
            </div>
        </div>

        <button class="action-button" id="play-button">–°—ã–≥—Ä–∞—Ç—å (15 ‚≠ê)</button>

        <div class="payment-section">
            <div class="section-title">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</div>
            <div class="payment-option">
                <div>15 –∑–≤–µ–∑–¥</div>
                <button class="payment-button" id="buy-15">–ö—É–ø–∏—Ç—å</button>
            </div>
            <div class="payment-option">
                <div>50 –∑–≤–µ–∑–¥</div>
                <button class="payment-button" id="buy-50">–ö—É–ø–∏—Ç—å</button>
            </div>
            <div class="payment-option">
                <div>100 –∑–≤–µ–∑–¥</div>
                <button class="payment-button" id="buy-100">–ö—É–ø–∏—Ç—å</button>
            </div>
        </div>

        <div class="premium-section">
            <div class="premium-title">–ü—Ä–µ–º–∏—É–º –≤–µ—Ä—Å–∏—è</div>
            <p>–ü–æ–ª—É—á–∏—Ç–µ –±–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤ –Ω–∞ –≤—ã–∏–≥—Ä—ã—à –∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏!</p>
            <p>–í—Å–µ–≥–æ –∑–∞ 15 –∑–≤–µ–∑–¥</p>
            <button class="telegram-button" id="buy-premium">–ö—É–ø–∏—Ç—å —á–µ—Ä–µ–∑ Telegram</button>
        </div>

        <div class="section history">
            <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</div>
            <div class="history-list" id="history-list">
                <div class="loader" id="history-loader"></div>
            </div>
        </div>
    </div>

    <script>
        const BOT_TOKEN = '8232129797:AAHmtF3yVaC65j5UFja3ubDdg5g9V_WiiIk';
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        let state = {
            balance: 0,
            betAmount: 15,
            selectedSymbol: null,
            history: [],
            userData: null
        };

        const balanceElement = document.getElementById('balance');
        const playButton = document.getElementById('play-button');
        const symbolItems = document.querySelectorAll('.symbol-item');
        const betOptions = document.querySelectorAll('.bet-option');
        const historyList = document.getElementById('history-list');
        const historyLoader = document.getElementById('history-loader');
        const buy15Button = document.getElementById('buy-15');
        const buy50Button = document.getElementById('buy-50');
        const buy100Button = document.getElementById('buy-100');
        const buyPremiumButton = document.getElementById('buy-premium');

        async function initUser() {
            const user = tg.initDataUnsafe?.user;
            if (!user) return;
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUserData`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: user.id
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    state.userData = data.result;
                    state.balance = data.result.balance || 0;
                    state.history = data.result.history || [];
                    updateBalance();
                    updateHistory();
                } else {
                    await createUser(user);
                }
            } catch (error) {
                console.error('Error initializing user:', error);
                await createUser(user);
            }
        }

        async function createUser(user) {
            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/createUser`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: user.id,
                        first_name: user.first_name,
                        last_name: user.last_name,
                        username: user.username,
                        balance: 15,
                        history: []
                    })
                });
                
                const data = await response.json();
                if (data.ok) {
                    state.userData = data.result;
                    state.balance = 15;
                    updateBalance();
                }
            } catch (error) {
                console.error('Error creating user:', error);
            }
        }

        async function updateUserData() {
            if (!state.userData) return;
            
            try {
                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/updateUser`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: state.userData.user_id,
                        balance: state.balance,
                        history: state.history
                    })
                });
            } catch (error) {
                console.error('Error updating user data:', error);
            }
        }

        function updateBalance() {
            balanceElement.textContent = `${state.balance} ‚≠ê`;
        }

        function updateBetAmount() {
            playButton.textContent = `–°—ã–≥—Ä–∞—Ç—å (${state.betAmount} ‚≠ê)`;
            playButton.disabled = state.betAmount > state.balance || state.selectedSymbol === null;
        }

        symbolItems.forEach(item => {
            item.addEventListener('click', () => {
                symbolItems.forEach(symbol => symbol.classList.remove('selected'));
                item.classList.add('selected');
                state.selectedSymbol = item.dataset.symbol;
                updateBetAmount();
            });
        });

        betOptions.forEach(option => {
            option.addEventListener('click', () => {
                betOptions.forEach(bet => bet.classList.remove('selected'));
                option.classList.add('selected');
                state.betAmount = parseInt(option.dataset.bet);
                updateBetAmount();
            });
        });

        playButton.addEventListener('click', async () => {
            if (state.betAmount > state.balance || state.selectedSymbol === null) return;
            
            const isWin = Math.random() < 0.02;
            const winMultiplier = 2 + (state.betAmount / 100);
            const winAmount = isWin ? Math.floor(state.betAmount * winMultiplier) : 0;
            
            state.balance = state.balance - state.betAmount + winAmount;
            
            state.history.unshift({
                symbol: state.selectedSymbol,
                bet: state.betAmount,
                win: winAmount,
                isWin: isWin,
                timestamp: new Date().toISOString()
            });
            
            updateBalance();
            updateHistory();
            updateUserData();
            
            showResult(isWin, winAmount);
        });

        function buyStars(amount) {
            if (!state.userData) return;
            
            tg.showPopup({
                title: '–ü–æ–∫—É–ø–∫–∞ –∑–≤–µ–∑–¥',
                message: `–û–ø–ª–∞—Ç–∞ ${amount} –∑–≤–µ–∑–¥...`,
                buttons: [{type: 'ok'}]
            });
            
            setTimeout(() => {
                state.balance += amount;
                updateBalance();
                updateBetAmount();
                updateUserData();
                
                tg.showPopup({
                    title: '–£—Å–ø–µ—à–Ω–æ!',
                    message: `–í—ã –ø—Ä–∏–æ–±—Ä–µ–ª–∏ ${amount} –∑–≤–µ–∑–¥!`,
                    buttons: [{type: 'ok'}]
                });
            }, 1500);
        }

        buy15Button.addEventListener('click', () => buyStars(15));
        buy50Button.addEventListener('click', () => buyStars(50));
        buy100Button.addEventListener('click', () => buyStars(100));
        buyPremiumButton.addEventListener('click', () => buyStars(15));

        function updateHistory() {
            if (state.history.length === 0) {
                historyList.innerHTML = '<div class="history-item">–ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä –ø—É—Å—Ç–∞</div>';
                return;
            }
            
            historyList.innerHTML = '';
            state.history.slice(0, 10).forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const symbolEmoji = getSymbolEmoji(item.symbol);
                const symbolName = getSymbolName(item.symbol);
                
                historyItem.innerHTML = `
                    <div class="history-symbol">
                        <span class="history-icon">${symbolEmoji}</span>
                        <span>${symbolName}</span>
                    </div>
                    <div class="history-result ${item.isWin ? 'history-win' : 'history-loss'}">
                        ${item.isWin ? '+' : '-'}${item.bet} ‚≠ê
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }

        function getSymbolEmoji(symbol) {
            const emojis = {
                'ring': 'üíç',
                'cup': 'üèÜ',
                'heart': '‚ù§Ô∏è',
                'bear': 'üêª',
                'diamond': 'üíé',
                'rose': 'üåπ'
            };
            return emojis[symbol] || '‚ùì';
        }

        function getSymbolName(symbol) {
            const names = {
                'ring': '–ö–æ–ª—å—Ü–æ',
                'cup': '–ö—É–±–æ–∫',
                'heart': '–°–µ—Ä–¥—Ü–µ',
                'bear': '–ú–µ–¥–≤–µ–¥—å',
                'diamond': '–ê–ª–º–∞–∑',
                'rose': '–†–æ–∑–∞'
            };
            return names[symbol] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }

        function showResult(isWin, amount) {
            if (isWin) {
                tg.showPopup({
                    title: '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!',
                    message: `–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ ${amount} ‚≠ê!`,
                    buttons: [{type: 'ok'}]
                });
            } else {
                tg.showPopup({
                    title: '–ù–µ –ø–æ–≤–µ–∑–ª–æ',
                    message: '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑!',
                    buttons: [{type: 'ok'}]
                });
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            betOptions[0].classList.add('selected');
            await initUser();
            updateBalance();
            updateBetAmount();
        });
    </script>
</body>
</html>
